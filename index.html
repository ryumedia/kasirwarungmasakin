<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kasir Mobile</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Memuat Phosphor Icons untuk ikon -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Memuat Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Latar belakang abu-abu muda */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        /* Kontainer Utama - Mensimulasikan rasio 9:16 pada perangkat seluler */
        .mobile-container {
            width: 100%;
            max-width: 400px; /* Lebar maksimal ponsel */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            background-color: white;
            position: relative;
        }
        @media (min-height: 800px) {
            .mobile-container {
                min-height: 720px; /* Fixed height for better simulation */
                aspect-ratio: 9/16; /* For desktop viewing simulation */
            }
        }
        /* Custom scrollbar style */
        .product-grid-container::-webkit-scrollbar {
            width: 8px;
        }
        .product-grid-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 0; /* Dibuat persegi */
        }
        .product-grid-container::-webkit-scrollbar-track {
            background-color: #f8fafc; /* slate-50 */
        }
        /* Menghapus semua border-radius untuk tampilan persegi penuh */
        .mobile-container, button, div, select {
            border-radius: 0 !important; 
        }
        
        /* Tambahkan style untuk visual focus yang lebih baik pada dropdown */
        #type-filter:focus {
            outline: 2px solid #4f46e5; /* indigo-600 */
            outline-offset: -2px;
        }
    </style>
</head>
<body class="p-4">

    <div id="app" class="mobile-container overflow-hidden">
        <!-- Header Aplikasi -->
        <header class="p-4 bg-indigo-600 text-white shadow-lg sticky top-0 z-10">
            <h1 class="text-xl font-bold flex items-center">
                <i class="ph-fill ph-storefront text-2xl mr-2"></i> Aplikasi Kasir
            </h1>
            <!-- ID Transaksi telah dihapus dari sini -->
        </header>

        <!-- Area Konten Utama (Produk & Keranjang) -->
        <div class="flex-grow flex flex-col overflow-hidden">

            <!-- 1. Daftar Produk (Scrollable - 60% Area) -->
            <div class="product-grid-container p-4 overflow-y-auto flex-1 h-3/5">
                <!-- DROP DOWN FILTER TIPE -->
                <div class="mb-4">
                    <label for="type-filter" class="text-sm font-medium text-gray-600 block mb-1">Pilih Tipe Produk:</label>
                    <select id="type-filter" class="w-full p-2 border border-gray-300 bg-white text-gray-800 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <!-- Opsi akan dirender di sini oleh JS -->
                    </select>
                </div>
                <!-- AKHIR DROP DOWN FILTER TIPE -->

                <div id="product-grid" class="grid grid-cols-2 gap-3">
                    <!-- Produk akan dirender di sini oleh JS -->
                    <p id="loading-message" class="col-span-2 text-center text-gray-500">Memuat data produk...</p>
                </div>
            </div>

            <!-- 2. Ringkasan Keranjang (Fixed Area - 40% Area) -->
            <div class="p-4 border-t-4 border-indigo-100 bg-white shadow-2xl h-2/5 flex flex-col">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">Keranjang Pesanan</h2>

                <!-- Daftar Item Keranjang (Scrollable) -->
                <div id="cart-list" class="flex-grow overflow-y-auto space-y-2 mb-3">
                    <p class="text-gray-500 text-sm italic" id="empty-cart-message">Keranjang kosong. Silakan pilih produk.</p>
                    <!-- Item keranjang akan dirender di sini -->
                </div>

                <!-- START: CUSTOMER SELECTION AREA -->
                <div class="mt-auto pt-2 border-t border-gray-200"> 
                    <div id="selected-customer-display" class="mb-3 p-2 bg-indigo-50 text-indigo-800 text-sm font-semibold flex justify-between items-center">
                        <span>Pelanggan Aktif:</span>
                        <span id="customer-name">Memuat...</span>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button id="registered-customer-btn" class="py-2 bg-indigo-500 text-white font-semibold hover:bg-indigo-600 transition duration-150 flex items-center justify-center">
                            <i class="ph ph-user-list text-xl mr-1"></i> Terdaftar
                        </button>
                        <button id="general-customer-btn" class="py-2 bg-gray-400 text-white font-semibold hover:bg-gray-500 transition duration-150 flex items-center justify-center">
                            <i class="ph ph-user-circle-gear text-xl mr-1"></i> Umum
                        </button>
                    </div>
                </div>
                <!-- END: CUSTOMER SELECTION AREA -->

                <!-- Footer Total dan Tombol Checkout -->
                <div id="total-summary" class="pt-3"> 
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-lg font-medium text-gray-600">Total Belanja:</span>
                        <span id="grand-total" class="text-2xl font-bold text-indigo-700">Rp 0</span>
                    </div>

                    <!-- START: PAYMENT METHOD SELECTION -->
                    <div class="mb-4">
                        <p class="text-sm font-semibold text-gray-700 mb-2">Metode Pembayaran:</p>
                        <div id="payment-method-container" class="grid grid-cols-3 gap-2">
                            <button id="cash-btn" data-method="cash" class="payment-method-btn py-2 text-sm bg-gray-200 text-gray-700 hover:bg-gray-300 transition flex items-center justify-center">
                                <i class="ph ph-money text-lg mr-1"></i> Tunai
                            </button>
                            <button id="transfer-btn" data-method="transfer" class="payment-method-btn py-2 text-sm bg-gray-200 text-gray-700 hover:bg-gray-300 transition flex items-center justify-center">
                                <i class="ph ph-bank text-lg mr-1"></i> Transfer
                            </button>
                            <button id="qris-btn" data-method="qris" class="payment-method-btn py-2 text-sm bg-gray-200 text-gray-700 hover:bg-gray-300 transition flex items-center justify-center">
                                <i class="ph ph-qr-code text-lg mr-1"></i> QRIS
                            </button>
                        </div>
                    </div>
                    <!-- END: PAYMENT METHOD SELECTION -->

                    <button id="checkout-button" class="w-full py-3 bg-indigo-600 text-white font-bold shadow-md shadow-indigo-300 hover:bg-indigo-700 transition duration-150 flex items-center justify-center disabled:opacity-50" disabled>
                        <i class="ph-fill ph-wallet text-xl mr-2"></i> Proses Pembayaran
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Pilih Pelanggan -->
        <div id="customer-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 shadow-2xl w-full max-w-sm transform transition-all flex flex-col max-h-[80vh]">
                <h3 class="text-xl font-bold text-indigo-600 mb-4 flex items-center border-b pb-2">
                    <i class="ph-fill ph-user-list text-2xl mr-2"></i> Pilih Pelanggan Terdaftar
                </h3>
                <div id="customer-list" class="flex-grow overflow-y-auto -mx-6 px-6 space-y-1">
                    <p class="text-center text-gray-500 p-4">Memuat data pelanggan...</p>
                    <!-- Daftar Pelanggan akan dimuat di sini -->
                </div>
                <div class="flex justify-end pt-4 space-x-3"> 
                     <button id="confirm-customer-btn" disabled class="py-2 px-4 bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition disabled:opacity-50">
                        Pilih
                    </button>
                    <button onclick="closeCustomerModal()" class="py-2 px-4 bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition">
                        Batal
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal Konfirmasi Pembayaran -->
        <div id="checkout-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 shadow-2xl w-full max-w-sm transform transition-all">
                <div id="checkout-success" class="text-center">
                    <h3 class="text-2xl font-bold text-green-600 mb-4 flex items-center justify-center">
                        <i class="ph-fill ph-check-circle text-3xl mr-2"></i> Transaksi Berhasil!
                    </h3>
                    <p class="text-gray-700 mb-4">Pembayaran senilai <span id="modal-total" class="font-bold text-lg text-indigo-600"></span> telah berhasil diproses.</p>
                    <p class="text-sm text-gray-600 mb-2">Pelanggan: <span id="modal-customer-name" class="font-medium text-indigo-500"></span></p>
                    <p class="text-sm text-gray-600 mb-4">Metode: <span id="modal-payment-method" class="font-medium text-indigo-500"></span></p>
                </div>
                
                <div id="checkout-fail" class="hidden text-center">
                    <h3 class="text-2xl font-bold text-red-600 mb-4 flex items-center justify-center">
                        <i class="ph-fill ph-x-circle text-3xl mr-2"></i> Transaksi Gagal!
                    </h3>
                    <p class="text-gray-700 mb-4">Terjadi kesalahan saat menyimpan data transaksi.</p>
                    <p id="modal-error-message" class="text-xs text-red-500 italic"></p>
                </div>

                <div class="flex justify-end pt-4">
                    <button onclick="closeModal(true)" class="py-2 px-4 bg-green-500 text-white font-semibold hover:bg-green-600 transition">
                        Selesai
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // LOKASI PENAMBAHAN: Konfigurasi dan Inisialisasi Supabase
        // *************************************************************************************
        // PENTING: HARUS GANTI DENGAN KREDENSIAL PROYEK SUPABASE ANDA!
        // Kesalahan 'Invalid supabaseUrl' muncul karena ini masih berupa teks placeholder.
        // Ganti 'GANTI_DENGAN_SUPABASE_URL_ANDA' dengan URL proyek Supabase Anda (misal: 'https://xyz123.supabase.co')
        // Ganti 'GANTI_DENGAN_SUPABASE_ANON_KEY_ANDA' dengan Anon Key Anda
        // *************************************************************************************
        const SUPABASE_URL = 'https://drfdjznyikcsercajaek.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyZmRqem55aWtjc2VyY2FqYWVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMTkyNTMsImV4cCI6MjA3NTU5NTI1M30.D2tbT9xTSblfG2Cvy4FEpZM5iqOr7FfMaIt6A-8Msuk'; 
        
        // ID PELANGGAN DEFAULT (sesuai permintaan)
        const DEFAULT_CUSTOMER_ID = '9029da8a-cd47-4634-bde6-b2459750ae42';
        
        // Inisialisasi Klien Supabase 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Data Aplikasi
        let products = []; 
        // Keranjang sekarang menyimpan kedua nilai: 'category' (untuk persistence) dan 'type' (untuk display)
        let cart = []; 
        let productTypes = []; // Akan diisi dari kolom 'type'
        let selectedType = 'all'; 
        
        let selectedCustomerId = DEFAULT_CUSTOMER_ID; 
        let selectedCustomerName = '-- Pilih Pelanggan --'; 
        let users = []; 
        
        let tempSelectedCustomerId = null;
        let tempSelectedCustomerName = null;
        
        let selectedPaymentMethod = null; 

        // Referensi DOM
        let cartListEl, grandTotalEl, emptyMessageEl, checkoutButtonEl;
        let productGridEl, checkoutModalEl, modalTotalEl, loadingMessageEl, typeFilterEl; 
        let customerNameEl, registeredCustomerBtnEl, generalCustomerBtnEl, customerModalEl, customerListEl, modalCustomerNameEl; 
        let confirmCustomerBtnEl;
        let paymentMethodContainerEl, modalPaymentMethodEl;
        let checkoutSuccessEl, checkoutFailEl, modalErrorMessageEl; 


        // --- Utility Functions ---

        /** Mengubah angka menjadi format mata uang Rupiah */
        const formatRupiah = (number) => {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        };
        
        /** Mengaktifkan/nonaktifkan tombol checkout */
        const updateCheckoutButtonState = () => {
            if (!checkoutButtonEl) return;
            // Checkout aktif jika keranjang tidak kosong DAN metode pembayaran sudah dipilih
            const isCartEmpty = cart.length === 0;
            const isPaymentSelected = selectedPaymentMethod !== null;
            
            checkoutButtonEl.disabled = isCartEmpty || !isPaymentSelected;
            
            // Perbarui visual tombol
            if (!isPaymentSelected && cart.length > 0) {
                 checkoutButtonEl.innerHTML = '<i class="ph-fill ph-warning-circle text-xl mr-2"></i> Pilih Metode Bayar!';
                 checkoutButtonEl.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                 checkoutButtonEl.classList.add('bg-red-500', 'hover:bg-red-600');
            } else {
                 checkoutButtonEl.innerHTML = '<i class="ph-fill ph-wallet text-xl mr-2"></i> Proses Pembayaran';
                 checkoutButtonEl.classList.remove('bg-red-500', 'hover:bg-red-600');
                 checkoutButtonEl.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }
        };


        // --- Customer Logic ---

        /** Mengupdate tampilan pelanggan yang dipilih */
        const updateCustomerDisplay = () => {
            if (customerNameEl) {
                customerNameEl.textContent = selectedCustomerName;
            }
        };

        /** Mengambil data pengguna (customer) dari Supabase dan mengurutkannya A-Z */
        const fetchUsers = async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('users') 
                    // Ambil semua kolom yang dibutuhkan untuk order
                    .select('id, full_name, email, phone_number'); 

                if (error) {
                    console.error('Error fetching users:', error.message);
                    return;
                }

                // LOGIKA: Urutkan data berdasarkan full_name A-Z (case-insensitive)
                users = data.sort((a, b) => {
                    const nameA = a.full_name.toUpperCase();
                    const nameB = b.full_name.toUpperCase();
                    if (nameA < nameB) return -1;
                    if (nameA > nameB) return 1;
                    return 0;
                });
            } catch (err) {
                console.error('Exception during fetchUsers:', err);
            }
        };
        
        /** Mengambil data pelanggan default (Umum) */
        const fetchDefaultCustomer = async () => {
            try {
                const { data, error } = await supabaseClient
                    .from('users') 
                    .select('id, full_name') // Hanya perlu nama untuk tampilan
                    .eq('id', DEFAULT_CUSTOMER_ID)
                    .single();

                if (error || !data) {
                    console.warn(`Customer default (ID: ${DEFAULT_CUSTOMER_ID}) tidak ditemukan. Menggunakan nama 'Umum' generik.`);
                    selectCustomer(DEFAULT_CUSTOMER_ID, 'Umum');
                    return;
                }
                selectCustomer(data.id, data.full_name);

            } catch (err) {
                console.error('Exception during fetchDefaultCustomer:', err);
                selectCustomer(DEFAULT_CUSTOMER_ID, 'Umum'); // Fallback aman
            }
        };

        /** Memilih pelanggan (Final Commit) */
        const selectCustomer = (id, name) => {
            selectedCustomerId = id;
            selectedCustomerName = name;
            
            console.log(`[DEBUG] Customer Set: ID=${selectedCustomerId}, Name=${selectedCustomerName}`);

            updateCustomerDisplay();
            closeCustomerModal();
        };
        
        /** Menyorot pilihan sementara di modal */
        const highlightCustomer = (id, name) => {
            if (!customerListEl || !confirmCustomerBtnEl) return;
            
            tempSelectedCustomerId = id;
            tempSelectedCustomerName = name;

            // Visual highlighting
            const allButtons = customerListEl.querySelectorAll('.select-customer-btn');
            allButtons.forEach(btn => {
                btn.classList.remove('bg-indigo-100', 'font-bold');
            });
            
            const selectedButton = customerListEl.querySelector(`[data-customer-id="${id}"]`);
            if (selectedButton) {
                 selectedButton.classList.add('bg-indigo-100', 'font-bold');
            }

            // Aktifkan tombol Pilih
            confirmCustomerBtnEl.disabled = false;
        };
        
        /** Mengkonfirmasi pemilihan pelanggan */
        const confirmCustomerSelection = () => {
            if (tempSelectedCustomerId && tempSelectedCustomerName) {
                // Pindahkan pilihan sementara ke pilihan aktif
                selectCustomer(tempSelectedCustomerId, tempSelectedCustomerName);
            } else {
                closeCustomerModal(); 
            }
            // Reset status sementara setelah konfirmasi
            tempSelectedCustomerId = null;
            tempSelectedCustomerName = null;
        };


        /** Menampilkan Modal Daftar Pelanggan */
        const showCustomerModal = async () => {
            if (!customerModalEl || !customerListEl || !confirmCustomerBtnEl) return;

            // Set status sementara ke pelanggan yang sudah aktif saat modal dibuka
            tempSelectedCustomerId = selectedCustomerId;
            tempSelectedCustomerName = selectedCustomerName;
            
            // Nonaktifkan tombol Pilih di awal jika belum ada pelanggan aktif
            confirmCustomerBtnEl.disabled = (selectedCustomerName === '-- Pilih Pelanggan --'); 

            // Pastikan data pengguna sudah dimuat dan diurutkan
            customerListEl.innerHTML = `<p class="text-center text-gray-500 p-4">Memuat data pelanggan...</p>`;
            await fetchUsers(); 
            
            if (users.length === 0) {
                customerListEl.innerHTML = `<p class="text-center text-gray-500 p-4">Tidak ada pelanggan terdaftar.</p>`;
            } else {
                // Render daftar pelanggan yang sudah terurut
                customerListEl.innerHTML = users.map(user => `
                    <button data-customer-id="${user.id}" data-customer-name="${user.full_name}"
                            class="select-customer-btn w-full p-3 text-left border-b border-gray-100 hover:bg-indigo-50 transition ${user.id === selectedCustomerId ? 'bg-indigo-100 font-bold' : ''}">
                        <span class="font-medium text-gray-800 block truncate">${user.full_name}</span>
                        <span class="text-xs text-gray-500 block truncate">${user.email || 'Tidak ada Email'}</span>
                    </button>
                `).join('');
            }

            customerModalEl.classList.remove('hidden');
        };

        /** Menutup Modal Pelanggan */
        const closeCustomerModal = () => {
            if (customerModalEl) {
                customerModalEl.classList.add('hidden');
            }
             // Reset status sementara
            tempSelectedCustomerId = null;
            tempSelectedCustomerName = null;
        };
        
        // --- Payment Logic ---
        
        /** Memilih metode pembayaran */
        const selectPaymentMethod = (method) => {
            selectedPaymentMethod = method;
            
            // Hapus highlight dari semua tombol
            const allButtons = paymentMethodContainerEl.querySelectorAll('.payment-method-btn');
            allButtons.forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-md', 'shadow-indigo-300');
                btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            });

            // Tambahkan highlight ke tombol yang dipilih
            const selectedButton = paymentMethodContainerEl.querySelector(`[data-method="${method}"]`);
            if (selectedButton) {
                selectedButton.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                selectedButton.classList.add('bg-indigo-600', 'text-white', 'shadow-md', 'shadow-indigo-300');
            }
            
            updateCheckoutButtonState();
        };


        // --- Product & Cart Logic ---
        
        /** Mengambil data produk dari Supabase */
        const fetchProducts = async () => {
            if (loadingMessageEl) loadingMessageEl.classList.remove('hidden');
            
            try {
                // PERBAIKAN: Ambil kolom 'category' (untuk persistence) DAN 'type' (untuk filtering UI)
                const { data, error } = await supabaseClient 
                    .from('products') 
                    .select('id, name, price, category, type, stock') // Mengambil kedua kolom
                    .eq('status', 'active'); // HANYA ambil produk yang statusnya 'active'

                if (loadingMessageEl) loadingMessageEl.classList.add('hidden');

                if (error) {
                    console.error('Error fetching products:', error.message);
                    if (productGridEl) productGridEl.innerHTML = `<p class="col-span-2 text-red-500 p-4">Gagal memuat produk: ${error.message}</p>`;
                    return;
                }

                products = data.map(p => ({
                    id: p.id,
                    name: p.name,
                    price: p.price || 0, 
                    // Nilai untuk dikirim ke orders.items
                    category: p.category || 'Lainnya', 
                    // Nilai untuk filtering di UI
                    type: p.type || 'Lainnya',
                    // BARU: Simpan status, meskipun sudah difilter 'active'
                    status: p.status,
                    stock: p.stock || 0
                }));
                
                console.log(`[DEBUG] Produk berhasil dimuat: ${products.length} item.`); 

                // LOGIKA: Gunakan properti 'type' untuk membuat daftar tipe unik (dropdown filter)
                const uniqueTypes = [...new Set(products.map(p => p.type).filter(Boolean))]; 
                productTypes = uniqueTypes.sort(); 

            } catch (err) {
                console.error('Exception during fetchProducts:', err);
                if (loadingMessageEl) loadingMessageEl.classList.add('hidden');
                if (productGridEl) productGridEl.innerHTML = `<p class="col-span-2 text-red-500 p-4">Terjadi kesalahan koneksi.</p>`;
            }
            
            // Render UI setelah data dimuat
            renderTypesDropdown(); 
            renderProducts(); 
            updateCartUI();
        };

        /** Merender dropdown tipe produk */
        const renderTypesDropdown = () => {
            if (!typeFilterEl) return;

            let optionsHtml = `
                <option value="all">Semua Tipe</option>
            `;

            // Opsi dibuat berdasarkan kolom 'type'
            optionsHtml += productTypes.map(type => `
                <option value="${type}" ${selectedType === type ? 'selected' : ''}>
                    ${type.charAt(0).toUpperCase() + type.slice(1)} <!-- Kapitalisasi hanya untuk tampilan di dropdown -->
                </option>
            `).join('');

            typeFilterEl.innerHTML = optionsHtml;
        };

        /** Mengubah tipe yang dipilih dan merender ulang produk */
        const selectType = (type) => {
            selectedType = type;
            renderProducts(); 
        };
        
        /** Menambahkan/mengupdate produk ke keranjang */
        const addProductToCart = (productId) => {
            // Memastikan perbandingan tipe data string vs string
            const product = products.find(p => String(p.id) === productId); 
            
            if (!product) {
                 console.error(`[ERROR] Produk dengan ID ${productId} tidak ditemukan di array 'products'.`); 
                 return;
            }

            const existingItem = cart.find(item => String(item.product_id) === productId); 

            if (existingItem) {
                existingItem.quantity++; 
            } else {
                cart.push({
                    product_id: product.id, 
                    product_name: product.name, 
                    price: product.price,
                    // PENTING: Untuk persistence (orders.items) menggunakan kolom 'category'
                    category: product.category,
                    type: product.type, 
                    quantity: 1 
                });
            }
            console.log(`[DEBUG] Produk ${product.name} (Cat: ${product.category}, Type: ${product.type}) berhasil ditambahkan/diperbarui.`);
            updateCartUI();
        };

        /** Mengubah kuantitas item di keranjang */
        const changeItemQuantity = (productId, change) => {
            const itemIndex = cart.findIndex(item => String(item.product_id) === productId); 

            if (itemIndex > -1) {
                cart[itemIndex].quantity += change; 

                if (cart[itemIndex].quantity <= 0) { 
                    cart.splice(itemIndex, 1); // Hapus jika kuantitas <= 0
                }
            }
            updateCartUI();
        };

        /** Menghitung total belanja */
        const calculateTotal = () => {
            return cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        };

        /** Merender daftar produk di UI */
        const renderProducts = () => {
            if (!productGridEl) return; 
            
            if (products.length === 0 && !loadingMessageEl.classList.contains('hidden')) {
                return;
            }

            // LOGIKA FILTER: Memfilter menggunakan properti internal 'type'
            const filteredProducts = selectedType === 'all'
                ? products
                : products.filter(p => p.type === selectedType);

            if (filteredProducts.length === 0) {
                const message = selectedType === 'all' 
                    ? `Tidak ada produk yang tersedia.`
                    : `Tidak ada produk di tipe ${selectedType}.`;
                    
                productGridEl.innerHTML = `<p class="col-span-2 text-center text-gray-500 p-4">${message}</p>`;
                return;
            }

            productGridEl.innerHTML = filteredProducts.map(p => {
                // LOGIKA BARU: Cek apakah stok habis (stock <= 0)
                const isOutOfStock = (p.stock || 0) <= 0; 

                // LOGIKA BARU UNTUK PERSISTENT HIGHLIGHT
                const isInCart = cart.some(item => String(item.product_id) === String(p.id)); 

                let cardClasses = 'transition-all duration-200 flex flex-col items-center justify-center text-center relative';

                if (isOutOfStock) {
                    // Jika Habis, gunakan kelas non-interaktif
                    cardClasses += ' bg-gray-200 text-gray-500 opacity-70 cursor-not-allowed';
                } else if (isInCart) {
                    // Jika ada di keranjang
                    cardClasses += ' bg-indigo-100 ring-2 ring-indigo-500 shadow-md hover:shadow-lg';
                } else {
                    // Default
                    cardClasses += ' bg-white border border-gray-200 shadow-sm hover:shadow-md';
                }

                // Tentukan apakah tombol harus dinonaktifkan
                const disabledAttribute = isOutOfStock ? 'disabled' : '';
                
                return `
                    <button data-product-id="${p.id}" ${disabledAttribute} class="add-product-btn p-3 ${cardClasses} w-full">
                        ${isOutOfStock ? `
                            <!-- Label "Habis" yang menindih card -->
                            <div class="absolute inset-0 bg-red-500 bg-opacity-50 text-white flex items-center justify-center text-xl font-bold z-10">
                                HABIS
                            </div>
                        ` : ''}

                        <i class="ph-duotone ph-cup text-3xl text-indigo-500 mb-1 ${isOutOfStock ? 'opacity-30' : ''}"></i>
                        <span class="text-sm font-semibold line-clamp-2 ${isOutOfStock ? 'text-gray-500' : 'text-gray-800'}">${p.name}</span>
                        <span class="text-xs text-green-600 mt-1 font-bold ${isOutOfStock ? 'text-gray-400' : ''}">${formatRupiah(p.price)}</span>
                    </button>
                `;
            }).join(''); 
        };

        /** Mengupdate UI Keranjang dan Total */
        const updateCartUI = () => {
            if (!cartListEl || !grandTotalEl || !emptyMessageEl || !checkoutButtonEl) {
                console.error("Kesalahan UI: Inisialisasi elemen kasir gagal.");
                return;
            }

            const total = calculateTotal();

            emptyMessageEl.classList.toggle('hidden', cart.length > 0);

            cartListEl.innerHTML = cart.map(item => `
                <div class="flex items-center justify-between p-2 bg-indigo-50">
                    <div class="flex-1 min-w-0 mr-2">
                        <span class="font-medium text-gray-800 block truncate">${item.product_name}</span> 
                        <!-- Tampilkan 'type' di keranjang untuk konsistensi filter UI -->
                        <span class="text-xs text-gray-500">${formatRupiah(item.price)} x ${item.quantity} (Tipe: ${item.type})</span> 
                    </div>
                    <div class="flex items-center space-x-1">
                        <button data-id="${item.product_id}" data-change="-1" class="qty-change-btn p-1 text-sm bg-indigo-200 text-indigo-700 hover:bg-indigo-300 transition"> 
                             <i class="ph ph-minus text-base"></i>
                        </button>
                        <span class="w-6 text-center text-sm font-semibold">${item.quantity}</span> 
                        <button data-id="${item.product_id}" data-change="1" class="qty-change-btn p-1 text-sm bg-indigo-500 text-white hover:bg-indigo-600 transition"> 
                            <i class="ph ph-plus text-base"></i>
                        </button>
                    </div>
                    <div class="ml-3 text-right">
                        <span class="font-bold text-sm text-indigo-700">${formatRupiah(item.price * item.quantity)}</span> 
                    </div>
                </div>
            `).join('');

            grandTotalEl.textContent = formatRupiah(total);
            updateCheckoutButtonState(); // Panggil fungsi cek status
            
            // Memastikan grid produk diperbarui setelah keranjang berubah
            renderProducts(); 
        };

        /** Proses Checkout dan Menyimpan ke Supabase */
        const handleCheckout = async () => {
            const total = calculateTotal();
            
            if (total === 0 || !selectedPaymentMethod) {
                console.warn('Keranjang kosong atau metode pembayaran belum dipilih.');
                return;
            }
            
            // Nonaktifkan tombol saat proses berlangsung
            checkoutButtonEl.disabled = true;
            checkoutButtonEl.innerHTML = '<i class="ph-fill ph-circle-notch animate-spin text-xl mr-2"></i> Memproses...';


            // 1. Dapatkan detail Pelanggan dari Supabase berdasarkan ID
            const { data: customerDetails, error: customerError } = await supabaseClient
                .from('users')
                .select('full_name, email, phone_number') 
                .eq('id', selectedCustomerId)
                .single();

            if (customerError || !customerDetails) {
                const message = `Gagal mengambil detail pelanggan (ID: ${selectedCustomerId}). Pastikan ID valid di tabel 'users'.`;
                console.error("Gagal mengambil detail pelanggan:", customerError || 'Data kosong');
                
                // Tampilkan pesan error ke pengguna
                checkoutModalEl.classList.remove('hidden');
                checkoutSuccessEl.classList.add('hidden');
                checkoutFailEl.classList.remove('hidden');
                modalErrorMessageEl.textContent = message;
                
                // Kembalikan tombol ke keadaan normal
                checkoutButtonEl.disabled = false;
                updateCheckoutButtonState(); 
                return; 
            }

            // 2. Persiapkan data Order, MENGGUNAKAN DETAIL PELANGGAN LENGKAP
            // >>>>>>>>>>> LOKASI KERANJANG DISIAPKAN UNTUK DIKIRIM (Baris 715) <<<<<<<<<<<<
            const itemsForSupabase = cart.map(item => {
                // Menggunakan object destructuring untuk mengeluarkan properti 'type'
                const { type, ...restOfItem } = item;
                return restOfItem;
            });

            const orderData = {
                // Customer Details diambil dari fetch
                user_id: selectedCustomerId,
                customer_name: customerDetails.full_name || selectedCustomerName, 
                customer_email: customerDetails.email || 'N/A', 
                customer_phone: customerDetails.phone_number || 'N/A', 
                
                // Order & Status Details
                total_amount: total, 
                total: total,      
                payment_method: selectedPaymentMethod,
                payment_status: 'paid', 
                
                // PENTING: Kirim data yang sudah dihilangkan 'type'-nya ke Supabase
                // Pastikan kolom 'items' di tabel 'orders' bertipe JSONB/ARRAY
                items: itemsForSupabase,
            };
            // >>>>>>>>>>> AKHIR LOKASI KERANJANG DISIAPKAN (Baris 728) <<<<<<<<<<<<
            
            console.log("Mencoba menyimpan Order dengan payload:", orderData);
            
            // 3. Kirim data Order ke tabel 'orders'
            // >>>>>>>>>>> LOKASI PENGIRIMAN DATA KE SUPABASE (Baris 735) <<<<<<<<<<<<
            const { data: orderResponse, error: orderError } = await supabaseClient
                .from('orders')
                .insert([orderData])
                .select(); 
            // >>>>>>>>>>> AKHIR LOKASI PENGIRIMAN DATA (Baris 740) <<<<<<<<<<<<
            
            let success = true;
            let errorMessage = '';

            if (orderError) {
                console.error("Gagal menyimpan Order:", orderError);
                success = false;
                errorMessage = `Gagal menyimpan transaksi: ${orderError.message}`;
            } else {
                console.log(`Order berhasil disimpan. ID Order: ${orderResponse[0].id}`);
            }

            // 4. Tampilkan Modal Hasil
            if (success) {
                // Tampilkan sukses
                checkoutSuccessEl.classList.remove('hidden');
                checkoutFailEl.classList.add('hidden');
                
                modalTotalEl.textContent = formatRupiah(total);
                modalCustomerNameEl.textContent = customerDetails.full_name || selectedCustomerName; 
                modalPaymentMethodEl.textContent = selectedPaymentMethod; 

            } else {
                // Tampilkan gagal
                checkoutSuccessEl.classList.add('hidden');
                checkoutFailEl.classList.remove('hidden');
                modalErrorMessageEl.textContent = errorMessage;
            }
            
            // Kembalikan tombol ke keadaan normal sebelum modal ditutup
            checkoutButtonEl.disabled = false;
            updateCheckoutButtonState(); 

            checkoutModalEl.classList.remove('hidden');
        };

        /** Menutup Modal dan mereset keranjang jika sukses */
        const closeModal = (reset) => {
            if (!checkoutModalEl) return;

            checkoutModalEl.classList.add('hidden');
            if (reset) {
                cart = [];
                selectedPaymentMethod = null; 
                
                fetchDefaultCustomer(); 
                
                updateCartUI();
            }
        };

        // --- Inisialisasi Aplikasi ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Inisialisasi semua elemen DOM (Cache references)
            cartListEl = document.getElementById('cart-list');
            grandTotalEl = document.getElementById('grand-total');
            emptyMessageEl = document.getElementById('empty-cart-message');
            checkoutButtonEl = document.getElementById('checkout-button');
            productGridEl = document.getElementById('product-grid');
            checkoutModalEl = document.getElementById('checkout-modal');
            modalTotalEl = document.getElementById('modal-total');
            loadingMessageEl = document.getElementById('loading-message');
            typeFilterEl = document.getElementById('type-filter'); 
            
            // Inisialisasi elemen Customer
            customerNameEl = document.getElementById('customer-name');
            registeredCustomerBtnEl = document.getElementById('registered-customer-btn');
            generalCustomerBtnEl = document.getElementById('general-customer-btn');
            customerModalEl = document.getElementById('customer-modal');
            customerListEl = document.getElementById('customer-list');
            modalCustomerNameEl = document.getElementById('modal-customer-name');
            confirmCustomerBtnEl = document.getElementById('confirm-customer-btn');
            
            // Inisialisasi elemen Pembayaran
            paymentMethodContainerEl = document.getElementById('payment-method-container');
            modalPaymentMethodEl = document.getElementById('modal-payment-method');
            
            // Inisialisasi elemen Modal Hasil 
            checkoutSuccessEl = document.getElementById('checkout-success');
            checkoutFailEl = document.getElementById('checkout-fail');
            modalErrorMessageEl = document.getElementById('modal-error-message');


            const appContainer = document.getElementById('app'); 

            if (!appContainer || !customerNameEl || !customerModalEl) {
                console.error("Gagal memuat semua elemen DOM penting. Aplikasi tidak dapat berjalan.");
                return;
            }
            
            // 2. Event Listeners
            
            // Listener untuk Dropdown Tipe (CHANGE event)
            typeFilterEl.addEventListener('change', (event) => {
                selectType(event.target.value);
            });

            // Listener untuk tombol "Terdaftar"
            registeredCustomerBtnEl.addEventListener('click', showCustomerModal);
            
            // Listener untuk tombol "Umum"
            generalCustomerBtnEl.addEventListener('click', () => {
                fetchDefaultCustomer(); 
            });
            
            // Listener untuk tombol "Pilih" di modal
            confirmCustomerBtnEl.addEventListener('click', confirmCustomerSelection);

            // Event Delegation untuk tombol di dalam grid, keranjang, modal, dan pembayaran
            appContainer.addEventListener('click', (event) => {
                const target = event.target.closest('button');
                if (!target) return;

                const productId = target.getAttribute('data-product-id'); 
                const itemId = target.getAttribute('data-id'); 
                const change = parseInt(target.getAttribute('data-change'));
                
                const customerId = target.getAttribute('data-customer-id');
                const customerName = target.getAttribute('data-customer-name');
                
                const paymentMethod = target.getAttribute('data-method'); 

                // Menambah Produk dari Grid
                if (target.classList.contains('add-product-btn') && productId) {
                    console.log(`[DEBUG] Tombol Produk diklik, ID: ${productId}`); 
                    addProductToCart(productId);
                } 
                
                // Mengubah Kuantitas di Keranjang
                else if (target.classList.contains('qty-change-btn') && itemId && !isNaN(change)) {
                    changeItemQuantity(itemId, change);
                } 
                
                // Memilih Pelanggan dari Modal (HANYA HIGHLIGHT)
                else if (target.classList.contains('select-customer-btn') && customerId && customerName) {
                    highlightCustomer(customerId, customerName);
                }
                
                // Memilih Metode Pembayaran
                else if (target.classList.contains('payment-method-btn') && paymentMethod) {
                    selectPaymentMethod(paymentMethod);
                }
                
                // Tombol Checkout
                else if (target.id === 'checkout-button' && !target.disabled) {
                    handleCheckout();
                }
            });

            // 3. Inisialisasi Data
            fetchProducts(); 
            fetchDefaultCustomer(); // Memastikan customer default dimuat
        });

    </script>
</body>
</html>
